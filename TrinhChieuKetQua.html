<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>B·∫£ng ƒêi·ªÉm Tr·ª±c Ti·∫øp</title>
<style>
body{font-family:Arial;background:black;color:white;text-align:center}
h1{font-size:50px;color:gold}
.rank{font-size:40px;margin:15px}
button{padding:10px 20px;font-size:18px;margin:10px}
</style>
</head>
<body>

<h1>üèÜ K·∫æT QU·∫¢ TR·ª∞C TI·∫æP</h1>
<div id="results"></div>

<button onclick="exportExcel()">üì• Xu·∫•t Excel</button>
<button onclick="resetScores()">üîÑ Reset</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "D√ÅN_API_KEY",
  authDomain: "PROJECT_ID.firebaseapp.com",
  databaseURL: "https://PROJECT_ID-default-rtdb.firebaseio.com",
  projectId: "PROJECT_ID",
  appId: "APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const resultsDiv = document.getElementById("results");

function animateValue(element, start, end, duration){
  let startTime = null;
  function animation(currentTime){
    if(!startTime) startTime = currentTime;
    const progress = Math.min((currentTime-startTime)/duration,1);
    element.innerHTML = (progress*(end-start)+start).toFixed(2);
    if(progress<1) requestAnimationFrame(animation);
  }
  requestAnimationFrame(animation);
}

onValue(ref(db,"scores"), snapshot=>{
  resultsDiv.innerHTML="";
  const data = snapshot.val();
  if(!data) return;

  let performances=[];

  for(let performance in data){
    let total=0,count=0;
    for(let judge in data[performance]){
      total+=data[performance][judge].score;
      count++;
    }
    performances.push({
      name:performance,
      avg:(total/count)
    });
  }

  performances.sort((a,b)=>b.avg-a.avg);

  performances.forEach((p,index)=>{
    const div=document.createElement("div");
    div.className="rank";

    let medal="";
    if(index==0) medal="ü•á";
    else if(index==1) medal="ü•à";
    else if(index==2) medal="ü•â";

    div.innerHTML=`${medal} H·∫°ng ${index+1}: ${p.name} - <span id="score${index}">0</span>`;
    resultsDiv.appendChild(div);

    const scoreSpan=document.getElementById("score"+index);
    animateValue(scoreSpan,0,p.avg,1000);
  });
});

window.resetScores=function(){
  if(confirm("X√≥a to√†n b·ªô ƒëi·ªÉm?")){
    remove(ref(db,"scores"));
  }
}

window.exportExcel=function(){
  import("https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js").then(()=>{
    onValue(ref(db,"scores"), snapshot=>{
      const data=snapshot.val();
      let rows=[];
      for(let performance in data){
        let total=0,count=0;
        for(let judge in data[performance]){
          total+=data[performance][judge].score;
          count++;
        }
        rows.push({
          "Ti·∫øt m·ª•c":performance,
          "Trung b√¨nh":(total/count).toFixed(2)
        });
      }

      const ws=XLSX.utils.json_to_sheet(rows);
      const wb=XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb,ws,"KetQua");
      XLSX.writeFile(wb,"KetQuaChamDiem.xlsx");
    },{onlyOnce:true});
  });
}
</script>
</body>
</html>
